# DMZ WAF の作成

引き続き、作成した PaaS 型 Web-DB システムの外側に WAF (Web Application Firewall) を追加し、パブリックインターネットからアクセスできるようにします。

- インターネットから当該システムにアクセスできるようにするための WAF は、業務システムを配置しているスポーク VNET の外側に、別の VNET （DMZ セグメントとなる VNET）を利用して作成します。
  - 下図に示すように、VNET ピアリングには「2 段ホップができない」という特性があります。このため、VNET を分けてそこに WAF を立てると、万が一 WAF がクラックされた場合でも、即時にハブ VNET やイントラネットまで侵入されるというリスクを低減することができます。
  - ![picture 1](./images/c5a6767689e403088ef5d1b860c463cf15999bd627ef51baf632cb262a015282.png)  
- 今回のシステムではさらにセキュリティを向上させるため、上記に加えて以下 2 つの対策を行っています。
  - DMZ セグメントに、PaaS サービス（マネージドサービス）である Application Gateway を利用して WAF を作成します。
    - IaaS VM を利用して自力でセキュリティ管理をするよりも遥かに容易に DMZ セグメントを構成できます。
    - また、Ops VNET からこの DMZ セグメントに VNET ピアリングをする必要もなくなりますので、運用 VNET へ侵入されることもなくなります。
  - DMZ セグメントからアプリへのアクセスに、プライベートエンドポイントを利用します。
    - これにより、DMZ セグメントからスポーク VNET に侵入されるリスクを軽減できます。
  - ![picture 2](../images/13c2a1dd82d5258d7dce4933e0237c550066494f90d91780a4f0b767329de4d4.png)  

なお、備考として、

- 本来であればこの Application Gateway では以下の 2 つの機能を有効化すべきですが、いずれも非常に高額なリソースであるため、今回は割愛します。
  - WAF 機能 (WAF SKU)
  - DDoS Protection Standard
- DMZ セグメント
  - ![picture 3](./images/12d0ba6f7f711b153dbc47041cc87364f085cec6e30b76e9cc8be0d250603a81.png)  


具体的な作業手順を以降に示します。
