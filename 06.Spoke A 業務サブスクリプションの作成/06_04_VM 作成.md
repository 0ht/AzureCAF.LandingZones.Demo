# VM 作成

```bash
 
# VM に必要な NIC 作成は業務システム側のアカウントではできない。
# このため、NIC 作成はネットワークチーム側で行ってもらう。
# ここでは VM 複数台を作成する関係で、作業途中でアカウントを切り替えるが、
# 実務では先に台数分の NIC をネットワークチーム側に作成してもらう。
 
 
# 業務システム A チーム／① 初期構築の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_spokea_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# Spoke A サブスクリプションで作業
az account set -s "${SUBSCRIPTION_ID_SPOKE_A}"
 
# Web/DB VM の作成
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
  TEMP_RG_NAME="rg-spokea-${TEMP_LOCATION_PREFIX}"
  TEMP_VNET_NAME="vnet-spokea-${TEMP_LOCATION_PREFIX}"
 
# 作成する VM の定義
TEMP_VM_DEFS="\
vm-web-${TEMP_LOCATION_PREFIX},Win2019DataCenter,WebSubnet \
vm-db-${TEMP_LOCATION_PREFIX},Win2019DataCenter,DbSubnet \
"
 
# その他テスト用の VM を作りたい場合
# TEMP_VM_DEFS="\
# vm-tmp00-${TEMP_LOCATION_PREFIX},canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest,DefaultSubnet \
# vm-tmp01-${TEMP_LOCATION_PREFIX},Win2019DataCenter,DefaultSubnet \
# vm-tmp02-${TEMP_LOCATION_PREFIX},Win2019DataCenter,DefaultSubnet \
# vm-tmp03-${TEMP_LOCATION_PREFIX},MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:latest,DefaultSubnet \
# vm-tmp04-${TEMP_LOCATION_PREFIX},MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition-core:latest,DefaultSubnet \
# vm-tmp05-${TEMP_LOCATION_PREFIX},canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest,DefaultSubnet \
# "
 
 
for TEMP_VM_DEF in $TEMP_VM_DEFS; do
  # 分解して利用
  TEMP=(${TEMP_VM_DEF//,/ })
  TEMP_VM_NAME=${TEMP[0]}
  TEMP_VM_IMAGE=${TEMP[1]}
  TEMP_SUBNET_NAME=${TEMP[2]}
  TEMP_SUBNET_ID=$(az network vnet subnet show --resource-group ${TEMP_RG_NAME} --vnet-name ${TEMP_VNET_NAME} --name ${TEMP_SUBNET_NAME} --query id -o tsv)
 
  echo "Creating ${TEMP_VM_NAME} (${TEMP_VM_IMAGE}) on ${TEMP_SUBNET_ID}..."
 
  TEMP_VM_NIC_NAME="${TEMP_VM_NAME}-nic"
 
# NW 構成管理チーム／③ 構成変更の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_nw_change@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
az account set -s "${SUBSCRIPTION_ID_SPOKE_A}"
 
# NIC 作成
  az network nic create --name "${TEMP_VM_NIC_NAME}" --subnet "${TEMP_SUBNET_ID}" --resource-group "${TEMP_RG_NAME}" --location ${TEMP_LOCATION_NAME}
 
# 業務システム A チーム／① 初期構築の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_spokea_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
az account set -s "${SUBSCRIPTION_ID_SPOKE_A}"
 
# VM 作成
  az vm create --name "${TEMP_VM_NAME}" --image ${TEMP_VM_IMAGE} --admin-username $ADMIN_USERNAME --admin-password $ADMIN_PASSWORD --nics "${TEMP_VM_NIC_NAME}" --resource-group "${TEMP_RG_NAME}" --location ${TEMP_LOCATION_NAME} --size Standard_D2s_v3
done
 
done

```
