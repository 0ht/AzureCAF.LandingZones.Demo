# MDfS 用の事前準備

```bash
# 共通基盤管理チーム／① 初期構築時の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_plat_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# 運用管理サブスクリプションに切り替え
az account set -s "${SUBSCRIPTION_ID_MGMT}"
 
# LAWS へのソリューションのインストール
# DCR の作成（ASA, FIM）
 
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
 
  TEMP_RG_NAME="rg-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_LAW_NAME="law-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_LAW_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourcegroups/rg-vdc-${TEMP_LOCATION_PREFIX}/providers/microsoft.operationalinsights/workspaces/${TEMP_LAW_NAME}"
  TEMP_DCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourcegroups/rg-vdc-${TEMP_LOCATION_PREFIX}/providers/microsoft.insights/datacollectionendpoints/dce-vdc-${TEMP_LOCATION_PREFIX}"
 
TEMP_DCR_ASA_NAME="dcr-law-vdc-${TEMP_LOCATION_PREFIX}-asa" # Microsoft-Security-dcr
TEMP_DCR_FIM_NAME="dcr-law-vdc-${TEMP_LOCATION_PREFIX}-fim"
 
cat <<EOF > tmp.json
{
  "\$schema": " https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "solutions": {
            "type": "array",
            "defaultValue": [
                "Security",
                "SecurityCenterFree",
                "SQLAdvancedThreatProtection",
                "SQLVulnerabilityAssessment",
                "ChangeTracking"
            ]
        },
        "workspaceName": {
            "type": "string",
            "defaultValue": "${TEMP_LAW_NAME}"
        },
        "workspaceId": {
            "type": "string",
            "defaultValue": "${TEMP_LAW_RESOURCE_ID}"
        }
    },
    "resources": [
        {
            "name": "[concat(parameters('solutions')[CopyIndex()], '(', parameters('workspaceName'), ')')]",
            "type": "Microsoft.OperationsManagement/solutions",
            "apiVersion": "2015-11-01-preview",
            "location": "${TEMP_LOCATION_NAME}",
            "tags": {},
            "plan": {
                "name": "[concat(parameters('solutions')[CopyIndex()], '(', parameters('workspaceName'), ')')]",
                "publisher": "Microsoft",
                "promotionCode": "",
                "product": "[concat('OMSGallery/', parameters('solutions')[CopyIndex()])]"
            },
            "properties": {
                "workspaceResourceId": "${TEMP_LAW_RESOURCE_ID}",
                "containedResources": [
                    "[concat(parameters('workspaceId'), '/views/', parameters('solutions')[CopyIndex()], '(', parameters('workspaceName'), ')')]"
                ]
            },
            "copy": {
                "name": "solutionAssignment",
                "count": "[length(parameters('solutions'))]"
            }
        }
    ]
}
EOF
az deployment group create --name "SolutionDeploy-${TEMP_LAW_NAME}" --resource-group $TEMP_RG_NAME --template-file tmp.json
 
# DCR の作成
 
cat <<EOF > dcr.json
{
    "location": "${TEMP_LOCATION_NAME}",
    "properties": {
        "description": "Data collection rule for Microsoft Defender for Cloud. Deleting this rule will break the detection of security vulnerabilities.",
        "dataCollectionEndpointId": "${TEMP_DCE_ID}",
        "dataSources": {
            "windowsEventLogs": [
                {
                    "streams": [
                        "Microsoft-RomeDetectionEvent"
                    ],
                    "xPathQueries": [
                        "Security!*",
                        "Microsoft-Windows-AppLocker/EXE and DLL!*"
                    ],
                    "name": "RomeDetectionEventDataSource"
                }
            ],
            "extensions": [
                {
                    "streams": [
                        "Microsoft-OperationLog",
                        "Microsoft-ProtectionStatus",
                        "Microsoft-ProcessInvestigator",
                        "Microsoft-Auditd"
                    ],
                    "extensionName": "AzureSecurityLinuxAgent",
                    "extensionSettings": {},
                    "name": "AscLinuxDataSource"
                },
                {
                    "streams": [
                        "Microsoft-OperationLog",
                        "Microsoft-ProtectionStatus",
                        "Microsoft-ProcessInvestigator"
                    ],
                    "extensionName": "AzureSecurityWindowsAgent",
                    "extensionSettings": {},
                    "name": "AsaWindowsDataSource"
                },
                {
                    "streams": [
                        "Microsoft-DefenderForSqlAlerts",
                        "Microsoft-DefenderForSqlLogins",
                        "Microsoft-SqlAtpStatus-DefenderForSql",
                        "Microsoft-DefenderForSqlTelemetry"
                    ],
                    "extensionName": "AdvancedThreatProtection",
                    "extensionSettings": {},
                    "name": "AdvancedThreatProtection"
                },
                {
                    "streams": [
                        "Microsoft-DefenderForSqlScanEvents",
                        "Microsoft-DefenderForSqlScanResults",
                        "Microsoft-DefenderForSqlTelemetry"
                    ],
                    "extensionName": "VulnerabilityAssessment",
                    "name": "VulnerabilityAssessment"
                }
            ]
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "${TEMP_LAW_RESOURCE_ID}",
                    "name": "LogAnalyticsDest"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Microsoft-OperationLog",
                    "Microsoft-ProtectionStatus",
                    "Microsoft-Auditd",
                    "Microsoft-RomeDetectionEvent",
                    "Microsoft-ProcessInvestigator",
                    "Microsoft-DefenderForSqlAlerts",
                    "Microsoft-DefenderForSqlLogins",
                    "Microsoft-SqlAtpStatus-DefenderForSql",
                    "Microsoft-DefenderForSqlTelemetry",
                    "Microsoft-DefenderForSqlScanEvents",
                    "Microsoft-DefenderForSqlScanResults"
                ],
                "destinations": [
                    "LogAnalyticsDest"
                ]
            }
        ]
    }
}
EOF
az monitor data-collection rule create --name ${TEMP_DCR_ASA_NAME} --resource-group "${TEMP_RG_NAME}" --location "${TEMP_LOCATION_NAME}" --rule-file dcr.json
 
cat <<EOF > dcr.json
{
    "location": "${TEMP_LOCATION_NAME}",
    "properties": {
        "description": "Data collection rule for change tracking agent.",
        "dataCollectionEndpointId": "${TEMP_DCE_ID}",
        "dataSources": {
            "extensions": [
                {
                    "streams": [
                        "Microsoft-ConfigurationChange"
                    ],
                    "extensionName": "ChangeTracking-Windows",
                    "extensionSettings": {
                        "enableFiles": true,
                        "enableSoftware": true,
                        "enableRegistry": true,
                        "enableServices": false,
                        "enableInventory": true,
                        "registrySettings": {
                            "registryCollectionFrequency": 3000,
                            "registryInfo": [
                                {
                                    "name": "Registry_1",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": false,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Group Policy\\\\Scripts\\\\Startup",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_2",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": false,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Group Policy\\\\Scripts\\\\Shutdown",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_3",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_4",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_5",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Classes\\\\Directory\\\\ShellEx\\\\ContextMenuHandlers",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_6",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Classes\\\\Directory\\\\Background\\\\ShellEx\\\\ContextMenuHandlers",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_7",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Classes\\\\Directory\\\\Shellex\\\\CopyHookHandlers",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_8",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\ShellIconOverlayIdentifiers",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_9",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\ShellIconOverlayIdentifiers",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_10",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Browser Helper Objects",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_11",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\Browser Helper Objects",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_12",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_13",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\Internet Explorer\\\\Extensions",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_14",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Drivers32",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_15",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Drivers32",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_16",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\System\\\\CurrentControlSet\\\\Control\\\\Session Manager\\\\KnownDlls",
                                    "valueName": ""
                                },
                                {
                                    "name": "Registry_17",
                                    "groupTag": "Recommended",
                                    "enabled": true,
                                    "recurse": true,
                                    "description": "",
                                    "keyName": "HKEY_LOCAL_MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Notify",
                                    "valueName": ""
                                }
                            ]
                        },
                        "fileSettings": {
                            "fileCollectionFrequency": 2700,
                            "fileinfo": [
                            ]
                        },
                        "softwareSettings": {
                            "softwareCollectionFrequency": 1800
                        },
                        "inventorySettings": {
                            "inventoryCollectionFrequency": 36000
                        },
                        "servicesSettings": {
                            "serviceCollectionFrequency": 1800
                        }
                    },
                    "name": "CTDataSource-Windows"
                },
                {
                    "streams": [
                        "Microsoft-ConfigurationChange"
                    ],
                    "extensionName": "ChangeTracking-Linux",
                    "extensionSettings": {
                        "enableFiles": true,
                        "enableSoftware": true,
                        "enableRegistry": false,
                        "enableServices": false,
                        "enableInventory": true,
                        "fileSettings": {
                            "fileCollectionFrequency": 900,
                            "fileInfo": [
                                {
                                    "name": "ChangeTrackingLinuxPath_default",
                                    "enabled": true,
                                    "destinationPath": "/etc/.*.conf",
                                    "useSudo": true,
                                    "recurse": true,
                                    "maxContentsReturnable": 5000000,
                                    "pathType": "File",
                                    "type": "File",
                                    "links": "Follow",
                                    "maxOutputSize": 500000,
                                    "groupTag": "Recommended"
                                }
                            ]
                        },
                        "softwareSettings": {
                            "softwareCollectionFrequency": 300
                        },
                        "inventorySettings": {
                            "inventoryCollectionFrequency": 36000
                        },
                        "servicesSettings": {
                            "serviceCollectionFrequency": 1800
                        }
                    },
                    "name": "CTDataSource-Linux"
                }
            ]
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "${TEMP_LAW_RESOURCE_ID}",
                    "name": "Microsoft-CT-Dest"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Microsoft-ConfigurationChange"
                ],
                "destinations": [
                    "Microsoft-CT-Dest"
                ]
            }
        ]
    }
}
EOF
az monitor data-collection rule create --name "${TEMP_DCR_FIM_NAME}" --resource-group "${TEMP_RG_NAME}" --location "${TEMP_LOCATION_NAME}" --rule-file dcr.json
 
done
 
# DCR 作成で以下のエラーが出た場合には、最初の LAW Solution のインストールが終わっていない
# その場合は数分置いてからスクリプトを再実行する
#(InvalidPayload) Data collection rule is invalid
#Code: InvalidPayload
#Message: Data collection rule is invalid
#Exception Details:      (InvalidOutputTable) Table for output stream 'Microsoft-ConfigurationChange' is not available for destination 'Microsoft-CT-Dest'.
#        Code: InvalidOutputTable
#        Message: Table for output stream 'Microsoft-ConfigurationChange' is not available for destination 'Microsoft-CT-Dest'.
#        Target: properties.dataFlows[0]

```
