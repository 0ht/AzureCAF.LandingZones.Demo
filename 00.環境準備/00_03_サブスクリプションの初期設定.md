# サブスクリプションの初期設定

各サブスクリプションに対して、基本的な初期設定を行います。

- MDfC の連続エクスポート設定を保存するためのリソースグループを作成します。
- いくつかの機能（リソースプロバイダ）を有効化します。
  - 多くの場合は、当該機能を利用する際に自動的にリソースプロバイダ登録が行われますが、 本サンプルでは厳格な権限分掌を行っている関係で、自動的なリソースプロバイダ登録が行えずにエラーが発生する場合があります。
  - 下記ではパッチ管理機能（UMC, Update Management Center）関連の機能のみ有効化を行っていますが、以降のスクリプトを実行している際にリソースプロバイダ不足によるエラーが発生した場合には、このリソースプロバイダ登録作業を適宜実施してください。

```bash
# 全サブスクリプションを対象に設定する
TEMP_TARGET_SUBSCRIPTION_IDS=$SUBSCRIPTION_IDS
 
for TEMP_SUBSCRIPTION_ID in $TEMP_TARGET_SUBSCRIPTION_IDS; do
echo "Initialize subscription... ${TEMP_SUBSCRIPTION_ID}"
az account set -s "${TEMP_SUBSCRIPTION_ID}"
 
# MDfC の連続エクスポート設定を保存しておくためのリソースグループを作っておく
echo "Creating resource group for security export settings... ${TEMP_SUBSCRIPTION_ID}"
TEMP_MAIN_LOCATION=${LOCATION_NAMES[0]}
TEMP_MAIN_RG_NAME="rg-security-${LOCATION_PREFIXS[0]}"
az group create --name ${TEMP_MAIN_RG_NAME} --location ${TEMP_MAIN_LOCATION}
 
# パッチ適用状況確認機能の有効化と自動パッチ適用制御機能の有効化
# （いずれも現在は Preview 機能のため）
az feature register --namespace Microsoft.Compute --name InGuestAutoAssessmentVMPreview
az feature register --namespace Microsoft.Compute --name InGuestScheduledPatchVMPreview
 
done
 
for TEMP_SUBSCRIPTION_ID in $TEMP_TARGET_SUBSCRIPTION_IDS; do
echo "Waiting initializing subscription... ${TEMP_SUBSCRIPTION_ID}"
az account set -s "${TEMP_SUBSCRIPTION_ID}"
 
# プロバイダ機能有効化待ち
while [ $(az feature show --namespace Microsoft.Compute --name InGuestAutoAssessmentVMPreview --query properties.state -o tsv) != "Registered" ]
do
  echo "$(az feature show --namespace Microsoft.Compute --name InGuestAutoAssessmentVMPreview --query properties.state -o tsv) InGuestAutoAssessmentVMPreview..."
  sleep 10
done
 
while [ $(az feature show --namespace Microsoft.Compute --name InGuestScheduledPatchVMPreview --query properties.state -o tsv) != "Registered" ]
do
  echo "$(az feature show --namespace Microsoft.Compute --name InGuestScheduledPatchVMPreview --query properties.state -o tsv) InGuestScheduledPatchVMPreview..."
  sleep 10
done
 
sleep 20
 
az provider register -n Microsoft.Compute
done
```
