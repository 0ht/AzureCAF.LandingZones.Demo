# コンテナアプリのビルド

- サンプルアプリとして ASP.NET Blazor Server アプリを利用します。
  - https://github.com/nakamacchi/AzRefArc.AspNetBlazorServer
- WSL 上にインストールした Docker を用いてビルドを行います。

## WSL Ubuntu のセットアップ

- WSL をインストール・セットアップ
  - 管理者権限のコマンドラインから wsl --install を実行
  - 再起動を求められるのでリブート
- Ubuntu のセットアップ
  - 再起動後、コマンドラインから ubuntu を実行
  - 初回時はユーザ名、パスワードを聞かれるので、以下などを指定
    - ユーザ名 : localadmin
    - パスワード : p&ssw0rdp&ssw0rd
- インストール後、Windows OS 側から WSL Ubuntu のフォルダにアクセスできることを確認します
  - \\wsl$\Ubuntu\home\localadmin にアクセスしてみてください。
  - Ubuntu の管理者のホームディレクトリを Explorer から開ければ OK です。

```cmd
C:\Users\azrefadmin>wsl --install
Downloading: Ubuntu
Installing: Ubuntu
Ubuntu has been installed.

C:\Users\azrefadmin>Ubuntu
Launching Ubuntu...
Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username: localadmin
New password:
Retype new password:
passwd: password updated successfully
Installation successful!
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.90.1-microsoft-standard-WSL2 x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This message is shown once a day. To disable it please create the
/home/localadmin/.hushlogin file.
localadmin@vm-mnt-eus:~$
```

## Docker (on WSL) のセットアップ

- Ubuntu を起動したあと、下記スクリプトを **1 行ずつ実行して** Docker を WSL 上にセットアップします。
- 初回 sudo 時は管理者パスワードを聞かれるので入力してください。

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
sudo apt update && sudo apt install -y docker-ce
sudo service docker start
sudo mkdir -p /sys/fs/cgroup/systemd
sudo mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd
sudo curl -L https://github.com/docker/compose/releases/download/1.26.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo gpasswd -a $USER docker
sudo chgrp docker /var/run/docker.sock
sudo service docker restart
```

## サンプルアプリのダウンロード

- Windows OS 側に戻り、以下の URL からサンプルアプリ（ASP.NET Blazor Server アプリ）のソースコードをダウンロードします。
  - https://github.com/nakamacchi/AzRefArc.AspNetBlazorServer/archive/refs/heads/master.zip
- ソースコードを WSL 側にコピーします。
  - zip ファイル内の AzRefArc.AspNetBlazorServer-master\AzRefArc.AspNetBlazorServer.BlazorServer フォルダを...
  - \\wsl$\Ubuntu\home\localadmin\AzRefArc.AspNetBlazorServer.BlazorServer フォルダにコピーします。

## サンプルアプリのコンパイルとビルド

- WSL Ubuntu に戻り、ソースコードフォルダに移動します。
  - cd ~/AzRefArc.AspNetBlazorServer.BlazorServer
- Dockerfile があるので、これを使ってビルドします。
  - sudo docker build -t app . としてコンテナを "app" という名前でビルドします。
- ビルド後、docker run コマンドでコンテナを起動・実行します。
  - sudo docker run -p:8080:80 app で実行できますが、この方法だけだとデータベースの接続文字列がオーバライドできません。
  - このため、下記に示すコマンドラインを手元で実行し、コンテナの起動引数で接続文字列をオーバライドするコマンドラインを入手します。
  - 上記で得られたコマンドラインを、WSL Ubuntu 上で実行してください。これにより、コンテナが稼働します。
- コンテナ起動後、vm-mtn-XXX の Windows OS 側に戻り、http://localhost:8080 を呼び出してください。
  - これによりアプリが起動すれば成功です。

```bash
sudo docker build -t app .
```

```bash
TEMP_SQL_SERVER_NAME="sql-spokef-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_SQL_DB_NAME="pubs"
# ローカルでの動作検証用の起動コマンドライン
echo "sudo docker run --env \"CONNECTIONSTRINGS__PUBSENTITIES=Server=tcp:${TEMP_SQL_SERVER_NAME}.database.windows.net,1433;Initial Catalog=pubs;Persist Security Info=False;User ID=${ADMIN_USERNAME};Password=${ADMIN_PASSWORD};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;\" -p:8080:80 app"

```
