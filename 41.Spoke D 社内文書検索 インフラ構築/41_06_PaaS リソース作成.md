# PaaS リソース作成

本業務システムで利用する PaaS リソースをまとめて作成します。

- AOAI
- Cosmos DB
- Cognitive Search
- Storage Account
- Form Recognizer
※ Web App は次のステップで作成します。

なお、一部のリソースについては作成可能なリージョンに制限があります。East US であれば特に問題なく作成できますが、Japan East では現在 AOAI が作成できないなどの制限があります。このような場合にはスクリプトを修正し、East US などにリソースを作成してください。

```bash

# Spoke D の作業アカウントで作業
# ※ AOAI が存在しないリージョンの場合について要検討（Global PE or Global VNET Peering）
# ※ Soft Delete 状態のリソースがあるとエラーを出す

# 業務システム D チーム／① 初期構築の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_spoked_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
az account set -s "${SUBSCRIPTION_ID_SPOKE_D}"
 
for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}

TEMP_RG_NAME="rg-spoked-${TEMP_LOCATION_PREFIX}"

TEMP_STORAGE_NAME="stspoked${UNIQUE_SUFFIX}${TEMP_LOCATION_PREFIX}"
TEMP_COSMOSDB_NAME="cos-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_SEARCHSERVICE_NAME="src-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_FORMRECOGNIZER_NAME="fmr-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_AOAI_NAME="aoai-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"

TEMP_COSMOSDB_SQLDB_NAME="ChatHistory"
TEMP_COSMOSDB_CONTAINER_NAME="Prompts"
TEMP_AOAI_DAVINCI_DEPLOYMENT_NAME="davinci"
TEMP_AOAI_GPT_35_TURBO_DEPLOYMENT_NAME="chat"
#TEMP_AOAI_GPT_4_32K_DEPLOYMENT=''
#TEMP_AOAI_GPT_4_DEPLOYMENT=''
#TEMP_AOAI_API_VERSION='2023-05-15'

# Soft Delete された前回のリソースがある場合はいったん Purge してから作成
TEMP_RES_ID=$(az cognitiveservices account list-deleted --query "[? name =='${TEMP_FORMRECOGNIZER_NAME}'].id" -o tsv)
if [[ -n $TEMP_RES_ID ]]; then
    az rest --method DELETE --url "${TEMP_RES_ID}?api-version=2021-10-01"
fi

TEMP_RES_ID=$(az cognitiveservices account list-deleted --query "[? name =='${TEMP_AOAI_NAME}'].id" -o tsv)
if [[ -n $TEMP_RES_ID ]]; then
    az rest --method DELETE --url "${TEMP_RES_ID}?api-version=2021-10-01"
fi

# Storage Account
az storage account create --name ${TEMP_STORAGE_NAME} --resource-group ${TEMP_RG_NAME} --location ${TEMP_LOCATION_NAME} --sku Standard_LRS --allow-blob-public-access false --public-network-access Disabled --default-action Deny --allow-shared-key-access false --bypass AzureServices --https-only true --kind StorageV2 --access-tier Hot

# Cosmos DB
# グローバルサービスであるためロケーションの指定方法が通常と異なることに注意
az cosmosdb create --name ${TEMP_COSMOSDB_NAME}  --resource-group ${TEMP_RG_NAME} --public-network-access DISABLED --network-acl-bypass AzureServices --default-consistency-level Session --enable-free-tier false --locations regionName="${TEMP_LOCATION_NAME}" failoverPriority=0 isZoneRedundant=False
az cosmosdb sql database create --resource-group ${TEMP_RG_NAME} --account-name ${TEMP_COSMOSDB_NAME} --name "${TEMP_COSMOSDB_SQLDB_NAME}" --throughput 400
az cosmosdb sql container create --resource-group ${TEMP_RG_NAME} --account-name ${TEMP_COSMOSDB_NAME} --database-name "${TEMP_COSMOSDB_SQLDB_NAME}" --name "${TEMP_COSMOSDB_CONTAINER_NAME}" --partition-key-path '/id' 

# Search Service
az search service create --resource-group "${TEMP_RG_NAME}" --name "${TEMP_SEARCHSERVICE_NAME}" --location ${TEMP_LOCATION_NAME} --sku Standard --identity-type SystemAssigned --public-access disabled  --partition-count 1 --replica-count 1

# Form Recognizer
az cognitiveservices account create --name ${TEMP_FORMRECOGNIZER_NAME} --resource-group ${TEMP_RG_NAME} --kind "FormRecognizer" --sku S0 --location ${TEMP_LOCATION_NAME} --yes

# AOAI
# https://learn.microsoft.com/en-us/azure/cognitive-services/openai/how-to/create-resource?pivots=cli
# TODO: AOAI が存在しないリージョンを指定した場合
# ※ リソース作成に失敗する場合は、作成が許可されているサブスクリプションであるかを確認
# 以前に AOAI リソースを作っていた場合には、当該リソースが正しく purge されているかも確認する（クォータが 1 であるため、Soft Deleted リソースが邪魔になってリソースが作成できない場合がある）
az cognitiveservices account create --name ${TEMP_AOAI_NAME} --resource-group ${TEMP_RG_NAME} --kind "OpenAI" --sku S0 --location ${TEMP_LOCATION_NAME} --yes

# text-davinci-003 は利用できなくなったので割愛
#az cognitiveservices account deployment create --name ${TEMP_AOAI_NAME} --resource-group ${TEMP_RG_NAME} \
#   --deployment-name "${TEMP_AOAI_DAVINCI_DEPLOYMENT_NAME}" \
#   --model-name "text-davinci-003" \
#   --model-version "1"  \
#   --model-format OpenAI \
#   --scale-settings-scale-type "Standard"

az cognitiveservices account deployment create --name ${TEMP_AOAI_NAME} --resource-group ${TEMP_RG_NAME} \
   --deployment-name "${TEMP_AOAI_GPT_35_TURBO_DEPLOYMENT_NAME}" \
   --model-name "gpt-35-turbo" \
   --model-version "0301"  \
   --model-format OpenAI \
   --scale-settings-scale-type "Standard"

# Cognitive Services （Form Recognizer, AOAI）のパブリックアクセスを禁止
# publicNetworkAccess = Deny, networkAcls Default Action = Deny の 2 つを設定
# Form Recognizer, AOAI については az cli でプロパティがないので az rest で処理
# カスタムドメインが有効になっていないと利用できないので、併せて有効化する

# Provisioning State を確認しながら進める
TEMP_ID="/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/${TEMP_RG_NAME}/providers/Microsoft.CognitiveServices/accounts/${TEMP_FORMRECOGNIZER_NAME}"
while [ $(az cognitiveservices account list --query "[? id == '${TEMP_ID}'].properties.provisioningState" -o tsv) != "Succeeded" ]
do
  echo "$(az cognitiveservices account list --query "[? id == '${TEMP_ID}'].properties.provisioningState" -o tsv) on ${TEMP_ID}..."
  sleep 10
done
az rest --method patch --uri "${TEMP_ID}?api-version=2021-04-30" --body "{\"properties\": {\"customSubDomainName\": \"${TEMP_FORMRECOGNIZER_NAME}\", \"publicNetworkAccess\": \"Disabled\",\"networkAcls\" : {\"defaultAction\":\"Deny\"}}}"

TEMP_ID="/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/${TEMP_RG_NAME}/providers/Microsoft.CognitiveServices/accounts/${TEMP_AOAI_NAME}"
while [ $(az cognitiveservices account list --query "[? id == '${TEMP_ID}'].properties.provisioningState" -o tsv) != "Succeeded" ]
do
  echo "$(az cognitiveservices account list --query "[? id == '${TEMP_ID}'].properties.provisioningState" -o tsv) on ${TEMP_ID}..."
  sleep 10
done
az rest --method patch --uri "${TEMP_ID}?api-version=2021-04-30" --body "{\"properties\": {\"customSubDomainName\": \"${TEMP_AOAI_NAME}\", \"publicNetworkAccess\": \"Disabled\",\"networkAcls\" : {\"defaultAction\":\"Deny\"}}}"

# Azure Container Registry 作成
# プライベートエンドポイント利用に Premium SKU が必要
TEMP_ACR_NAME="acrspoked${UNIQUE_SUFFIX}${TEMP_LOCATION_PREFIX}"
az acr create --name $TEMP_ACR_NAME --resource-group $TEMP_RG_NAME --sku Premium --public-network-enabled false

done # TEMP_LOCATION

```
