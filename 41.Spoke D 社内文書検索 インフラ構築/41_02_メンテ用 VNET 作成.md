# メンテ用 VNET の作成

メンテナンス作業を行うための VM を置くための NET を作成します。この VNET には Ops VNET からのみ接続できるようにします。

```bash

# NW チームの作業アカウントで作業

az account set -s "${SUBSCRIPTION_ID_SPOKE_D}"
 
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
 
  # Spoke D データメンテナンス作業用 VNET 作成
  TEMP_RG_NAME="rg-spokedmtn-${TEMP_LOCATION_PREFIX}"
  TEMP_VNET_NAME="vnet-spokedmtn-${TEMP_LOCATION_PREFIX}"
  TEMP_IP_PREFIX=${IP_SPOKE_D_PREFIXS[$i]}
  TEMP_VNET_ADDRESS="${TEMP_IP_PREFIX}.128.0/17"
  TEMP_SUBNET_DEFAULT="${TEMP_IP_PREFIX}.128.0/24"
  TEMP_SUBNET_PE="${TEMP_IP_PREFIX}.129.0/24"
  TEMP_NSG_NAME="${TEMP_VNET_NAME}-nsg"
  TEMP_UDR_NAME="${TEMP_VNET_NAME}-udr"
 
  az group create --name ${TEMP_RG_NAME} --location ${TEMP_LOCATION_NAME}
  az network nsg create --name ${TEMP_NSG_NAME} --resource-group ${TEMP_RG_NAME}
  az network vnet create --resource-group ${TEMP_RG_NAME} --name ${TEMP_VNET_NAME} --address-prefixes ${TEMP_VNET_ADDRESS}
  az network vnet subnet create --name "DefaultSubnet" --address-prefix ${TEMP_SUBNET_DEFAULT} --resource-group ${TEMP_RG_NAME} --vnet-name ${TEMP_VNET_NAME} --nsg ${TEMP_NSG_NAME}
  az network vnet subnet create --name "PrivateEndpointSubnet" --address-prefix ${TEMP_SUBNET_PE} --resource-group ${TEMP_RG_NAME} --vnet-name ${TEMP_VNET_NAME} --nsg ${TEMP_NSG_NAME}

  # UDR 作成
  az network route-table create --resource-group ${TEMP_RG_NAME} --name ${TEMP_UDR_NAME}
 
  az account set -s "${SUBSCRIPTION_NAME_MGMT}"
  TEMP_FW_IP=$(az network firewall ip-config list -g "rg-ops-${TEMP_LOCATION_PREFIX}" -f "fw-ops-${TEMP_LOCATION_PREFIX}" --query "[0].privateIpAddress" --output tsv)
  az account set -s "${SUBSCRIPTION_NAME_SPOKE_D}"
 
  az network route-table route create --resource-group ${TEMP_RG_NAME} --name default --route-table-name ${TEMP_UDR_NAME} --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --next-hop-ip-address ${TEMP_FW_IP}
 
  # UDR 割り当て
  az network vnet subnet update --resource-group ${TEMP_RG_NAME} --route-table ${TEMP_UDR_NAME} --ids $(az network vnet subnet show --resource-group ${TEMP_RG_NAME} --vnet-name $TEMP_VNET_NAME --name "DefaultSubnet" --query id -o tsv)
  az network vnet subnet update --resource-group ${TEMP_RG_NAME} --route-table ${TEMP_UDR_NAME} --ids $(az network vnet subnet show --resource-group ${TEMP_RG_NAME} --vnet-name $TEMP_VNET_NAME --name "PrivateEndpointSubnet" --query id -o tsv)

  # VNET Peering
  TEMP_OPS_VNET_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourceGroups/rg-ops-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Network/virtualNetworks/vnet-ops-${TEMP_LOCATION_PREFIX}"
  TEMP_SPOKE_VNET_ID="/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/${TEMP_RG_NAME}/providers/Microsoft.Network/virtualNetworks/${TEMP_VNET_NAME}"
 
  # Ops → Spoke
  az network vnet peering create --name spokedmtn --resource-group "rg-ops-${TEMP_LOCATION_PREFIX}" --vnet-name "vnet-ops-${TEMP_LOCATION_PREFIX}" --remote-vnet $TEMP_SPOKE_VNET_ID --allow-vnet-access --subscription "${SUBSCRIPTION_NAME_MGMT}"
 
  # Spoke → Ops
  az network vnet peering create --name ops --resource-group ${TEMP_RG_NAME} --vnet-name ${TEMP_VNET_NAME} --remote-vnet $TEMP_OPS_VNET_ID --allow-vnet-access --subscription "${SUBSCRIPTION_NAME_SPOKE_D}"

  # DNS サーバ切り替え
  az network vnet update --name ${TEMP_VNET_NAME} --resource-group ${TEMP_RG_NAME} --dns-servers ${TEMP_FW_IP}

done
 





```
