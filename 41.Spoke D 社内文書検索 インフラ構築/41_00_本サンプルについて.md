# 本サンプルについて

本サンプルは、エンプラ系規制業界での利用を想定し、AOAI リファレンスアーキテクチャ資料のサンプル 4. 社内文章検索システムを、Azure CAF Landing Zone 上に移植したものです。

## 全体アーキテクチャとオリジナル版からの変更点

![Alt text](images/image.png)

- エンプラ系の規制業界でよく求められる、閉域構成のアーキテクチャを採用しています。
  - PaaS 系リソースへはパブリックアクセス不可、Web App も VNET 統合による閉域化を行っています。
  - このため、各リソースへの直接のデータ操作アクセスは、VNET の外部からでは行えません。データの中身を確認したい場合には、運用管理端末（vm-ops-XXX）や保守用端末（vm-mtn-XXX）にアクセスし、そこから行ってください。
- オリジナルのアーキテクチャでは本番／運用分離が考慮されていませんが、規制業界での利用を想定し、データやアプリのメンテナンスを行うための環境（ネットワーク）と、社内文章を検索するための環境（ネットワーク）とを分離しています。
- オリジナルのサンプルでは、データの投入やアプリのメンテナンスをローカルマシンから実施していましたが、本サンプルではハードニングされた専用 VM （vm-mtn-XXX）を用意し、ここにツールを入れて、そこからデータの投入やアプリのメンテナンスを行えるように設計しています。
  - この vm-mtn-XXX は直接インターネットに出ることができないように設計しています。
  - 本サンプルでは、各種資源の持ち込みはいったんインターネット接続可能な端末（vm-ops-XXX）で行い、そこからリモートデスクトップ接続を使って vm-mtn-XXX にコピーする形にしています。実際の持ち込み方法（vm-mtn-XXX から限定的なサーバに対してだけは穴を開ける、Azure Files などでファイルをコピーして持ち込む、等）については実際に取り扱うデータのセキュリティ要件などを鑑みて、個別にご検討ください。

## アプリケーションコードの変更点

- この環境で動作させられるように、オリジナルのアプリケーションコードを以下のように修正しています。
  - 全般
    - azd コマンドから動作させるために用意されている各種のラッパー処理をすべて削除し、必要最小限のファイルだけを aoai-sample4.zip ファイルに抽出しています。
  - prepdocs.py
    - インデックスを事前作成するための Python スクリプトです。
    - オリジナル版では azd コマンドから処理を実行するためにクレデンシャルを AzureDeveloperCredential() から入手していますが、本サンプルでは VM 上から Managed ID を利用するため、DefaultAzureCredential() を利用するように変更しています。
  - webapp
    - アプリケーションプログラム本体です。frontend フォルダ内に React アプリが含まれており、backend フォルダ内に Python Flask アプリが含まれています。
    - オリジナル版ではこのアプリを直接 Web App for Linux 上に配置していますが、汎用性を考慮し、Docker コンテナ化したうえで、 Web App for Containers 上に展開するようにしています。
    - コンテナでは Python Flask の開発サーバをそのまま利用しています。ローカル環境以外からのリクエストも受け付けられるように、app.py の最後の 2 行を以下のように修正しています。

```Python

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)

```

## 認証・認可設計

![Alt text](images/image-1.png)

- リソースアクセスはすべて Managed Identity を利用する設計としています。共有キーアクセスは利用していません。
- リソースアクセス権限は、すべてリソーススコープで付与しています。（リソースグループスコープでの権限付与は行っていません。）
- リソースアクセス権限は Azure RBAC（DataAction を持つロール）で設定していますが、Cosmos DB は Cosmos DB 独自の RBAC で設定しています。

## まだ実装されていない部分

- 権限分掌に基づいた作業分担（現状ではすべての構築作業を管理者権限で行う設計になっています）
