# プライベートエンドポイント作成①

各種 PaaS リソースのプライベートエンドポイントを Spoke VNET 内に作成します。

## プライベートエンドポイントの作成方法

プライベートエンドポイントの作成に必要なパラメータはリソースごとに変わりますが、この実装を容易化するため、az network private-link-resource list を利用しています。これにより、作成対象となるリソース ID を元にして、作成に必要になるグループ ID 情報と DNS ゾーン情報を動的に入手し、処理を進めるようにしています。

```bash

# Spoke D サブスクリプションで作業
az account set -s "${SUBSCRIPTION_ID_SPOKE_D}"
 
for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}

TEMP_RG_NAME="rg-spoked-${TEMP_LOCATION_PREFIX}"

TEMP_STORAGE_NAME="stspoked${UNIQUE_SUFFIX}${TEMP_LOCATION_PREFIX}"
TEMP_COSMOSDB_NAME="cos-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_SEARCHSERVICE_NAME="src-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_FORMRECOGNIZER_NAME="fmr-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_AOAI_NAME="aoai-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"
TEMP_WEBAPP_NAME="webapp-spoked-${UNIQUE_SUFFIX}-${TEMP_LOCATION_PREFIX}"

TEMP_VNET_NAME="vnet-spoked-${TEMP_LOCATION_PREFIX}"
TEMP_SUBNET_NAME="PrivateEndpointSubnet"
az network vnet subnet update --name "${TEMP_SUBNET_NAME}" --vnet-name $TEMP_VNET_NAME --resource-group $TEMP_RG_NAME --disable-private-endpoint-network-policies

# PE を作成するリソースの定義
TEMP_RESOURCE_IDS="\
/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/rg-spoked-${TEMP_LOCATION_PREFIX}/providers/Microsoft.CognitiveServices/accounts/${TEMP_AOAI_NAME}
/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/rg-spoked-${TEMP_LOCATION_PREFIX}/providers/Microsoft.DocumentDB/databaseAccounts/${TEMP_COSMOSDB_NAME}
/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/rg-spoked-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Storage/storageAccounts/${TEMP_STORAGE_NAME}
/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/rg-spoked-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Search/searchServices/${TEMP_SEARCHSERVICE_NAME}
/subscriptions/${SUBSCRIPTION_ID_SPOKE_D}/resourceGroups/rg-spoked-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Web/sites/${TEMP_WEBAPP_NAME}
"

for TEMP_RESOURCE_ID in $TEMP_RESOURCE_IDS; do

TEMP_RESOURCE_NAME=${TEMP_RESOURCE_ID##*/}
TEMP_GROUP_ID=$(az network private-link-resource list --id ${TEMP_RESOURCE_ID} --query "[0].properties.groupId" -o tsv)
TEMP_REQUIRED_ZONE_NAMES=$(az network private-link-resource list --id ${TEMP_RESOURCE_ID} --query "[0].properties.requiredZoneNames" -o tsv)
TEMP_PE_NAME="pe-${TEMP_RESOURCE_NAME}"

az network private-endpoint create --resource-group $TEMP_RG_NAME --vnet-name $TEMP_VNET_NAME --subnet "${TEMP_SUBNET_NAME}" --name $TEMP_PE_NAME --private-connection-resource-id $TEMP_RESOURCE_ID --group-ids "${TEMP_GROUP_ID}"  --connection-name "${TEMP_RESOURCE_NAME}_${TEMP_VNET_NAME}"

# Hub サブスクリプションに作成済みの Private DNS Zone にレコードを登録
echo $TEMP_REQUIRED_ZONE_NAMES
for TEMP_REQUIRED_ZONE_NAME in $TEMP_REQUIRED_ZONE_NAMES; do
TEMP_PRIVATE_DNS_ZONE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourceGroups/rg-privatednszones-${LOCATION_PREFIXS[0]}/providers/Microsoft.Network/privateDnsZones/${TEMP_REQUIRED_ZONE_NAME}"

TEMP_ISEXISTS=$(az rest --method get --uri "${TEMP_PRIVATE_DNS_ZONE_ID}?api-version=2020-06-01" --query id -o tsv)
if [[ $TEMP_ISEXISTS == *"ERROR"* || -z $TEMP_ISEXISTS ]]; then
  echo "Private DNS Zone does not exist. Creating Private DNS Zone on Mgmt Subscription."
  TEMP_MAIN_RG_NAME="rg-privatednszones-${LOCATION_PREFIXS[0]}"
  az network private-dns zone create --resource-group ${TEMP_MAIN_RG_NAME} --name ${TEMP_REQUIRED_ZONE_NAME} --subscription "${SUBSCRIPTION_ID_MGMT}"
else
  echo "Private DNS Zone already exists."
fi

az network private-endpoint dns-zone-group create --endpoint-name ${TEMP_PE_NAME} --name "pdzg-${TEMP_PE_NAME}" --private-dns-zone $TEMP_PRIVATE_DNS_ZONE_ID --resource-group ${TEMP_RG_NAME} --zone-name "${TEMP_REQUIRED_ZONE_NAME}"

done # TEMP_REQUIRED_ZONE_NAME
done # TEMP_RESOURCE_ID
done # TEMP_LOCATION






```
