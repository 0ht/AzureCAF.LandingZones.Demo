# リソースグループの作成と VNET の作成

DMZ セグメントをスポーク VNET の外側に作るため、リソースグループも分けておきます。VNET はピアリングを使って vnet-spokef に接続しておきます。

```bash

########################
# リソースグループ作成

# 業務システム B チーム／① 初期構築の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_spokef_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
az account set -s "${SUBSCRIPTION_ID_SPOKE_F}"

for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}

TEMP_RG_NAME="rg-spokefdmz-${TEMP_LOCATION_PREFIX}"

# DMZ セグメントのリソースグループの作成
az group create --name $TEMP_RG_NAME --location ${TEMP_LOCATION_NAME}

done # TEMP_LOCATION

########################
# VNET 作成

# NW 構成管理チーム／③ 構成変更の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_nw_change@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi

# Spoke F サブスクリプションで作業
az account set -s "${SUBSCRIPTION_ID_SPOKE_F}"

for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}

TEMP_RG_NAME="rg-spokefdmz-${TEMP_LOCATION_PREFIX}"
TEMP_VNET_NAME="vnet-spokefdmz-${TEMP_LOCATION_PREFIX}"
TEMP_NSG_NAME="${TEMP_VNET_NAME}-nsg"
TEMP_UDR_NAME="${TEMP_VNET_NAME}-udr"

# DMZ セグメントの VNET 作成
az network vnet create --resource-group $TEMP_RG_NAME --name $TEMP_VNET_NAME --address-prefixes "192.168.0.0/16"
az network nsg create --name ${TEMP_NSG_NAME} --resource-group ${TEMP_RG_NAME}
az network route-table create --resource-group ${TEMP_RG_NAME} --name ${TEMP_UDR_NAME}
az network vnet subnet create --name "DmzSubnet" --address-prefix "192.168.10.0/24" --resource-group $TEMP_RG_NAME --vnet-name $TEMP_VNET_NAME --route-table ${TEMP_UDR_NAME}

# VNET Peering spokef-spokefdmz
TEMP_DMZ_VNET_ID="/subscriptions/${SUBSCRIPTION_ID_SPOKE_F}/resourceGroups/rg-spokefdmz-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Network/virtualNetworks/vnet-spokefdmz-${TEMP_LOCATION_PREFIX}"
TEMP_SPOKE_VNET_ID="/subscriptions/${SUBSCRIPTION_ID_SPOKE_F}/resourceGroups/rg-spokef-${TEMP_LOCATION_PREFIX}/providers/Microsoft.Network/virtualNetworks/vnet-spokef-${TEMP_LOCATION_PREFIX}"
# DMZ → Spoke
az network vnet peering create --name spokef --resource-group "rg-spokefdmz-${TEMP_LOCATION_PREFIX}" --vnet-name "vnet-spokefdmz-${TEMP_LOCATION_PREFIX}" --remote-vnet $TEMP_SPOKE_VNET_ID --allow-vnet-access
# Spoke → DMZ
az network vnet peering create --name dmz --resource-group "rg-spokef-${TEMP_LOCATION_PREFIX}" --vnet-name "vnet-spokef-${TEMP_LOCATION_PREFIX}" --remote-vnet $TEMP_DMZ_VNET_ID --allow-vnet-access

done # TEMP_LOCATION

```
