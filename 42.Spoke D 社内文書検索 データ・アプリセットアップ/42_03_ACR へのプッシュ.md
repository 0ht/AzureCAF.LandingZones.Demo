# ACR へのプッシュ

先の手順で適切なコンテナがビルドされたので、これを ACR にプッシュします。ACR へのプッシュの方法はいくつかありますが、ここでは ACR の管理者アカウント（ユーザ名／パスワードによる認証）を有効化して利用します。

- 下記のスクリプトを実行し、
  - ACR の管理者アカウントを有効化します。
  - Container Apps に、ACR へのアクセス権を付与します。（レジストリアクセスに利用するユーザ名・パスワードを設定しておきます。）
  - vm-mtn-XXX の WSL Ubuntu 上で実行する 4 つのコマンドを作成します。
- 4 つの実行コマンドを、順次 vm-mtn-XXX の WSL Ubuntu 上で実行します。これにより、ACR 上に azrefarc.blazorserver:latest タグでコンテナがプッシュされます。

```bash

# 業務システム D チーム／① 初期構築の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_spoked_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# Spoke D サブスクリプションで作業
az account set -s "${SUBSCRIPTION_ID_SPOKE_D}"
 
for i in ${VDC_NUMBERS}; do
TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
TEMP_RG_NAME="rg-spoked-${TEMP_LOCATION_PREFIX}"
TEMP_ACR_NAME="acrspoked${UNIQUE_SUFFIX}${TEMP_LOCATION_PREFIX}"
TEMP_CAE_NAME="cae-spoked-${TEMP_LOCATION_PREFIX}"
TEMP_CA_NAME="ca-spoked-${TEMP_LOCATION_PREFIX}"

#############################################
# ACA から ACR への MID によるコンテナ pull がうまく動作しないため、管理者アカウントでアクセスする
# az containerapp registry set --resource-group "${TEMP_RG_NAME}" --name "${TEMP_CA_NAME}" --server ${TEMP_ACR_NAME}.azurecr.io --identity system

# 管理者アカウントの有効化
az acr update --name $TEMP_ACR_NAME --resource-group $TEMP_RG_NAME --admin-enabled true
TEMP_ACR_USERNAME=$(az acr credential show --name $TEMP_ACR_NAME --resource-group $TEMP_RG_NAME --query username -o tsv)
TEMP_ACR_PASSWORD=$(az acr credential show --name $TEMP_ACR_NAME --resource-group $TEMP_RG_NAME --query passwords[0].value -o tsv)
# az containerapp registry set --resource-group "${TEMP_RG_NAME}" --name "${TEMP_CA_NAME}" --server ${TEMP_ACR_NAME}.azurecr.io --username ${TEMP_ACR_USERNAME} --password ${TEMP_ACR_PASSWORD}


#############################################

# レジストリプッシュスクリプトの作成
cat <<EOF
# Docker ビルド
sudo docker build . -t app
# Docker ログイン
sudo docker login ${TEMP_ACR_NAME}.azurecr.io  --username ${TEMP_ACR_USERNAME} --password ${TEMP_ACR_PASSWORD}
# タグ付け
sudo docker tag app:latest ${TEMP_ACR_NAME}.azurecr.io/aoai.sample4:latest
# アップロード
sudo docker push ${TEMP_ACR_NAME}.azurecr.io/aoai.sample4:latest
EOF

done #TEMP_LOCATION

```

実行結果（一例）は以下のようになります。

```bash

azrefadmin@vm-mnt-eus:~/src/webapp$ sudo docker build . -t app
[+] Building 2.9s (17/17) FINISHED                                                                       docker:default
 => [internal] load build definition from Dockerfile                                                               0.2s
 => => transferring dockerfile: 619B                                                                               0.1s
 => [internal] load .dockerignore                                                                                  0.1s
 => => transferring context: 2B                                                                                    0.0s
 => [internal] load metadata for docker.io/library/python:3.10                                                     0.4s
 => [internal] load metadata for docker.io/library/node:lts                                                        0.3s
 => [build1 1/6] FROM docker.io/library/node:lts@sha256:c85dc4392f44f5de1d0d72dd20a088a542734445f99bed7aa8ac895c7  0.0s
 => [final 1/5] FROM docker.io/library/python:3.10@sha256:b24f2d9aaa0093ee4fa95a1a524badbaed4d5c7fda68ae6005b8145  0.0s
 => [internal] load build context                                                                                  2.1s
 => => transferring context: 5.17kB                                                                                2.0s
 => CACHED [final 2/5] WORKDIR /webapp                                                                             0.0s
 => CACHED [build1 2/6] WORKDIR /webapp                                                                            0.0s
 => CACHED [build1 3/6] COPY . .                                                                                   0.0s
 => CACHED [build1 4/6] WORKDIR /webapp/frontend                                                                   0.0s
 => CACHED [build1 5/6] RUN npm install                                                                            0.0s
 => CACHED [build1 6/6] RUN npm run build                                                                          0.0s
 => CACHED [final 3/5] COPY --from=build1 /webapp /webapp                                                          0.0s
 => CACHED [final 4/5] WORKDIR /webapp/backend                                                                     0.0s
 => CACHED [final 5/5] RUN python -m pip install -r ./requirements.txt                                             0.0s
 => exporting to image                                                                                             0.0s
 => => exporting layers                                                                                            0.0s
 => => writing image sha256:af28f1c8d77aca3e4efe9ba7587b9fd1444d18b1695bcf8148f747907a454706                       0.0s
 => => naming to docker.io/library/app                                                                             0.0s
azrefadmin@vm-mnt-eus:~/src/webapp$ sudo docker login acrspoked07541eus.azurecr.io  --username acrspoked07541eus --password xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
azrefadmin@vm-mnt-eus:~/src/webapp$ sudo docker tag app:latest acrspoked07541eus.azurecr.io/aoai-sample4:latest
azrefadmin@vm-mnt-eus:~/src/webapp$ sudo docker push acrspoked07541eus.azurecr.io/aoai-sample4:latest
The push refers to repository [acrspoked07541eus.azurecr.io/aoai-sample4]
2644ed4543b8: Pushed
5f70bf18a086: Pushed
71a89cf6368b: Pushed
6a7cf1733de6: Pushed
590598117129: Pushed
980fef3df566: Pushed
9bd21ac8c9e8: Pushed
c5f1d4dd95f0: Pushed
6a25221bdf24: Pushed
b578f477cd5d: Pushed
b298f9991a11: Pushed
c94dc8fa3d89: Pushed
latest: digest: sha256:0140b411bc1be262e47f4afc4f36f6bbc84aff7417ce09ed1929c2ca960059d6 size: 2843
azrefadmin@vm-mnt-eus:~/src/webapp$

```
